<!-- gestion/templates/gestion/login.html -->
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Iniciar Sesión</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <!-- CSS Corregido para centrar ambas tarjetas -->
    <style>
      body {
        /* Alinea todo verticalmente */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        background-color: #f8f9fa;
        padding: 20px 0;
      }
      .login-card,
      .demo-card {
        width: 100%;
        max-width: 400px;
      }
      .demo-card {
        margin-top: 20px;
        font-size: 0.9em;
      }
      .demo-card .list-group-item {
        padding: 0.75rem 1rem;
      }
      .demo-card strong {
        color: #0056b3;
      }
      .reset-password-card {
        margin-top: 20px;
      }
    </style>
    <!-- Firebase SDK -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getAuth, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      
      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBBaZY2-tp24fMt3uc13gLRpu9KnGOFA9g",
        authDomain: "backend-proyecto-lilis.firebaseapp.com",
        projectId: "backend-proyecto-lilis",
        storageBucket: "backend-proyecto-lilis.firebasestorage.app",
        messagingSenderId: "623897780641",
        appId: "1:623897780641:web:944a48ae895d049f7c6be0",
        measurementId: "G-BBXJEKTWEK"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);

      // Make auth available globally
      window.firebaseAuth = auth;
      window.sendPasswordResetEmail = sendPasswordResetEmail;
      
      // Función helper para enviar email de restablecimiento
      window.sendPasswordReset = async function(email) {
        try {
          // No usar actionCodeSettings - Firebase usará la URL por defecto configurada en Firebase Console
          await sendPasswordResetEmail(auth, email);
          return { success: true };
        } catch (error) {
          return { success: false, error: error };
        }
      };
    </script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SweetAlert2 para alertas bonitas -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body>
    <!-- 1. Tarjeta de Login (Sin cambios) -->
    <div class="card login-card shadow-sm bg-danger">
      <div class="card-body p-4 p-md-5">
        <div class="w-50 mx-auto">
          <img
            src="../../static/gestion/img/logo.png"
            alt=""
            class="img-fluid"
          />
        </div>
        <h2 class="card-title text-center mb-4 text-white">Iniciar Sesión</h2>
        <form method="POST">
          {% csrf_token %} {% if form.errors %}
          <div class="alert alert-danger" role="alert">
            Tu usuario o contraseña son incorrectos.
          </div>
          {% endif %}

          <div class="form-floating mb-3">
            <input
              type="text"
              name="username"
              class="form-control"
              id="id_username"
              placeholder="Usuario o Email"
              required
            />
            <label for="id_username">Usuario o Email</label>
          </div>

          <div class="form-floating mb-3">
            <input
              type="password"
              name="password"
              class="form-control"
              id="id_password"
              placeholder="Contraseña"
              required
            />
            <label for="id_password">Contraseña</label>
          </div>

          <button
            class="btn btn-primary w-100 btn-lg bg-danger bg-opacity-75 border-warning fs-5 fw-bold"
            type="submit"
          >
            Entrar
          </button>
          
          <div class="text-center mt-3">
            <a href="#" class="text-white text-decoration-underline" id="forgot-password-link" style="font-size: 0.9rem;">
              ¿Olvidaste tu contraseña?
            </a>
          </div>
        </form>
      </div>
    </div>

    <!-- 2. TARJETA: Reestablecer Contraseña (oculta por defecto) -->
    <div class="card reset-password-card shadow-sm" id="reset-password-card" style="display: none;">
      <div class="card-body p-4">
        <h5 class="card-title text-center mb-3">Reestablecer Contraseña</h5>
        <form id="reset-password-form">
          <div class="mb-3">
            <label for="reset-email" class="form-label">Correo Electrónico:</label>
            <input
              type="email"
              class="form-control"
              id="reset-email"
              placeholder="Ingresa tu correo electrónico"
              required
            />
            <small class="form-text text-muted">
              Te enviaremos un enlace para reestablecer tu contraseña.
            </small>
          </div>
          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary">Enviar Enlace</button>
            <button type="button" class="btn btn-secondary" id="cancel-reset">Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- 3. TARJETA: Credenciales de Demo -->
    <div class="card demo-card shadow-sm">
      <div class="card-body">
        <h5 class="card-title text-center text-muted">Credenciales de Demo</h5>
        <ul class="list-group list-group-flush">
          <li class="list-group-item">
            <strong>Rol:</strong> Admin<br />
            <strong>User:</strong> admin / <strong>Pass:</strong> 123456
          </li>
          <li class="list-group-item">
            <strong>Rol:</strong> Operador de Bodega<br />
            <strong>User:</strong> bodeguero / <strong>Pass:</strong> 123456
          </li>
          <li class="list-group-item">
            <strong>Rol:</strong> Operador de Ventas<br />
            <strong>User:</strong> vendedor / <strong>Pass:</strong> 123456
          </li>
        </ul>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const resetPasswordCard = document.getElementById('reset-password-card');
        const resetPasswordForm = document.getElementById('reset-password-form');
        const cancelResetBtn = document.getElementById('cancel-reset');
        const loginCard = document.querySelector('.login-card');

        // Mostrar formulario de reestablecimiento
        if (forgotPasswordLink) {
          forgotPasswordLink.addEventListener('click', function(e) {
            e.preventDefault();
            loginCard.style.display = 'none';
            resetPasswordCard.style.display = 'block';
          });
        }

        // Ocultar formulario de reestablecimiento
        if (cancelResetBtn) {
          cancelResetBtn.addEventListener('click', function() {
            resetPasswordCard.style.display = 'none';
            loginCard.style.display = 'block';
            resetPasswordForm.reset();
          });
        }

        // Manejar envío del formulario de reestablecimiento
        if (resetPasswordForm) {
          resetPasswordForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('reset-email').value.trim();

            if (!email) {
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Por favor, ingresa un correo electrónico válido.'
              });
              return;
            }

            if (!window.firebaseAuth) {
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Firebase no está inicializado correctamente. Recarga la página e intenta de nuevo.'
              });
              return;
            }

            // Mostrar loading
            Swal.fire({
              title: 'Enviando...',
              text: 'Por favor espera mientras enviamos el correo.',
              allowOutsideClick: false,
              allowEscapeKey: false,
              showConfirmButton: false,
              didOpen: () => {
                Swal.showLoading();
              }
            });

            try {
              // Intentar enviar el correo usando la función helper
              if (window.sendPasswordReset) {
                const result = await window.sendPasswordReset(email);
                if (result.success) {
                  Swal.fire({
                    icon: 'success',
                    title: '¡Correo enviado!',
                    html: `
                      <p>Se ha enviado un enlace de restablecimiento de contraseña a:</p>
                      <p><strong>${email}</strong></p>
                      <p class="mt-3">Revisa tu bandeja de entrada y la carpeta de spam.</p>
                      <p class="text-muted small mt-2">Si no recibes el correo en unos minutos, verifica que el correo esté correcto.</p>
                    `,
                    confirmButtonText: 'OK'
                  }).then(() => {
                    resetPasswordCard.style.display = 'none';
                    loginCard.style.display = 'block';
                    resetPasswordForm.reset();
                  });
                } else {
                  throw result.error;
                }
              } else {
                // Fallback: usar sendPasswordResetEmail directamente sin actionCodeSettings
                await window.sendPasswordResetEmail(window.firebaseAuth, email);
                
                Swal.fire({
                  icon: 'success',
                  title: '¡Correo enviado!',
                  html: `
                    <p>Se ha enviado un enlace de restablecimiento de contraseña a:</p>
                    <p><strong>${email}</strong></p>
                    <p class="mt-3">Revisa tu bandeja de entrada y la carpeta de spam.</p>
                  `,
                  confirmButtonText: 'OK'
                }).then(() => {
                  resetPasswordCard.style.display = 'none';
                  loginCard.style.display = 'block';
                  resetPasswordForm.reset();
                });
              }
            } catch (error) {
              console.error('Error al enviar correo de restablecimiento:', error);
              
              let errorMessage = 'Ocurrió un error al enviar el correo.';
              let errorTitle = 'Error';
              
              if (error.code) {
                switch (error.code) {
                  case 'auth/user-not-found':
                    errorMessage = 'No existe una cuenta con este correo electrónico en Firebase.';
                    errorTitle = 'Usuario no encontrado';
                    break;
                  case 'auth/invalid-email':
                    errorMessage = 'El correo electrónico no es válido.';
                    errorTitle = 'Correo inválido';
                    break;
                  case 'auth/too-many-requests':
                    errorMessage = 'Demasiados intentos. Por favor, espera unos minutos e intenta de nuevo.';
                    errorTitle = 'Demasiados intentos';
                    break;
                  case 'auth/unauthorized-domain':
                    errorMessage = 'Este dominio no está autorizado. Contacta al administrador.';
                    errorTitle = 'Dominio no autorizado';
                    break;
                  case 'auth/unauthorized-continue-uri':
                    errorMessage = 'La URL de redirección no está autorizada. Verifica la configuración en Firebase Console.';
                    errorTitle = 'URL no autorizada';
                    break;
                  default:
                    errorMessage = error.message || `Error: ${error.code}`;
                }
              } else if (error.message) {
                errorMessage = error.message;
              }

              Swal.fire({
                icon: 'error',
                title: errorTitle,
                html: `
                  <p>${errorMessage}</p>
                  <p class="text-muted small mt-3">Código de error: ${error.code || 'desconocido'}</p>
                  <p class="text-muted small">Verifica que el correo esté correcto y que el dominio esté autorizado en Firebase Console.</p>
                `,
                confirmButtonText: 'Entendido'
              });
            }
          });
        }
      });
    </script>
  </body>
</html>
