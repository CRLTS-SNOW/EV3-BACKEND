<!-- gestion/templates/gestion/sale_list.html -->
{% extends 'gestion/base.html' %}
<!--  -->
{% block title %}Historial de Ventas{% endblock %}
<!--  -->
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Historial de Ventas</h2>
  <div>
    <a href="{% url 'export_sales_excel' %}" class="btn btn-success me-2">
      Exportar a Excel
    </a>
    <a href="{% url 'sale_create' %}" class="btn btn-primary">
      + Nueva Venta (POS)
    </a>
  </div>
</div>

<!-- Buscador -->
<div class="card card-body mb-3">
  <form method="GET" action="" class="row g-3 align-items-center">
    <div class="col-auto">
      <input
        type="text"
        name="q"
        id="sale-live-search-input"
        class="form-control"
        value="{{ search_query }}"
        placeholder="Buscar por cliente o ID de venta..."
      />
    </div>
    <div class="col-auto">
      <label for="sort-select" class="form-label mb-0">Ordenar por:</label>
    </div>
    <div class="col-auto">
      <select id="sort-select" name="sort" class="form-select" onchange="this.form.submit()">
        <option value="-date" {% if current_sort == '-date' or not current_sort %}selected{% endif %}>Fecha (Más Reciente)</option>
        <option value="date" {% if current_sort == 'date' %}selected{% endif %}>Fecha (Más Antigua)</option>
        <option value="client" {% if current_sort == 'client' %}selected{% endif %}>Cliente (A-Z)</option>
        <option value="-client" {% if current_sort == '-client' %}selected{% endif %}>Cliente (Z-A)</option>
        <option value="total" {% if current_sort == 'total' %}selected{% endif %}>Total (Menor a Mayor)</option>
        <option value="-total" {% if current_sort == '-total' %}selected{% endif %}>Total (Mayor a Menor)</option>
        <option value="id" {% if current_sort == 'id' %}selected{% endif %}>ID (Menor a Mayor)</option>
        <option value="-id" {% if current_sort == '-id' %}selected{% endif %}>ID (Mayor a Menor)</option>
      </select>
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-primary" style="display: none;">Buscar</button>
    </div>
    {% if search_query %}
    <div class="col-auto">
      <a href="{% url 'sale_list' %}" class="btn btn-secondary">Limpiar</a>
    </div>
    {% endif %}
  </form>
</div>

<div class="card">
  <div class="table-responsive">
    <table class="table table-striped table-hover mb-0">
      <thead>
        <tr>
          <th>ID Venta</th>
          <th>Fecha</th>
          <th>Cliente</th>
          <th>Vendedor</th>
          <th>Total</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="sale-list-body">
        {% include 'gestion/includes/sale_table_body.html' %}
      </tbody>
    </table>
  </div>
</div>

<!-- Paginador -->
{% if page_obj.paginator.num_pages > 1 %}
<nav class="mt-4">
  <ul class="pagination justify-content-center">
    {% if page_obj.has_previous %}
    <li class="page-item">
      <a class="page-link" href="?page=1&q={{ search_query }}&sort={{ current_sort }}">&laquo;</a>
    </li>
    <li class="page-item">
      <a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ search_query }}&sort={{ current_sort }}"
        >Anterior</a
      >
    </li>
    {% endif %}
    <li class="page-item active" aria-current="page">
      <span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
    </li>
    {% if page_obj.has_next %}
    <li class="page-item">
      <a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ search_query }}&sort={{ current_sort }}"
        >Siguiente</a
      >
    </li>
    <li class="page-item">
      <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&q={{ search_query }}&sort={{ current_sort }}"
        >&raquo;</a
      >
    </li>
    {% endif %}
  </ul>
</nav>
{% endif %}

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.getElementById('sale-live-search-input');
    const resultsBody = document.getElementById('sale-list-body');
    const searchURL = "{% url 'api_search_sales_live' %}";
    const searchForm = searchInput.closest('form');

    if (searchForm) {
      searchForm.addEventListener('submit', (e) => {
        e.preventDefault();
      });
    }
    
    const performSearch = async (query) => {
      try {
        const url = `${searchURL}?q=${encodeURIComponent(query)}`;
        const response = await fetch(url);
        
        if (response.headers.get('content-type') === 'application/json') {
          const data = await response.json();
          if (response.ok) {
            resultsBody.innerHTML = data.html;
          } else {
            console.error("Error en la búsqueda:", data);
            resultsBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error al cargar resultados.</td></tr>';
          }
        } else {
          console.error("La respuesta del servidor no fue JSON. Código:", response.status);
          resultsBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error de comunicación con el servidor.</td></tr>';
        }
      } catch (error) {
        console.error("Error de red o procesamiento:", error);
        resultsBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error de conexión.</td></tr>';
      }
    };

    let debounceTimer;
    searchInput.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') return;
      clearTimeout(debounceTimer);
      const query = e.target.value.trim();
      debounceTimer = setTimeout(() => {
        if (query.length >= 1 || query.length === 0) {
          performSearch(query);
        }
      }, 300);
    });
  });
</script>
{% endblock %}
