{% extends 'gestion/base.html' %}
{% block title %}Lista de Movimientos{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Lista de Movimientos de Productos</h2>
  <div>
    <a href="{% url 'export_movements_excel' %}{% if search_query or type_filter %}?{% if search_query %}q={{ search_query|urlencode }}{% endif %}{% if search_query and type_filter %}&{% endif %}{% if type_filter %}type={{ type_filter|urlencode }}{% endif %}{% endif %}" class="btn btn-success me-2">
      Exportar a Excel
    </a>
    <a href="{% url 'product_movement' %}" class="btn btn-primary">
      + Nuevo Movimiento
    </a>
  </div>
</div>

<!-- Filtros y Buscador -->
<div class="card card-body mb-3">
  <form method="GET" action="" class="row g-3 align-items-center">
    <div class="col-auto">
      <input
        type="text"
        name="q"
        id="movement-live-search-input"
        class="form-control"
        value="{{ search_query }}"
        placeholder="Buscar por producto, SKU o motivo..."
      />
    </div>
    <div class="col-auto">
      <select name="type" id="movement-type-filter" class="form-select">
        <option value="">Todos los tipos</option>
        <option value="ENTRY" {% if type_filter == 'ENTRY' %}selected{% endif %}>Entrada de Stock</option>
        <option value="EXIT" {% if type_filter == 'EXIT' %}selected{% endif %}>Salida de Stock</option>
        <option value="TRANSFER" {% if type_filter == 'TRANSFER' %}selected{% endif %}>Transferencia Interna</option>
      </select>
    </div>
    <div class="col-auto">
      <label for="sort-select" class="form-label mb-0">Ordenar por:</label>
    </div>
    <div class="col-auto">
      <select id="sort-select" name="sort" class="form-select" onchange="this.form.submit()">
        <option value="-date" {% if current_sort == '-date' or not current_sort %}selected{% endif %}>Fecha (Más Reciente)</option>
        <option value="date" {% if current_sort == 'date' %}selected{% endif %}>Fecha (Más Antigua)</option>
        <option value="product" {% if current_sort == 'product' %}selected{% endif %}>Producto (A-Z)</option>
        <option value="-product" {% if current_sort == '-product' %}selected{% endif %}>Producto (Z-A)</option>
        <option value="quantity" {% if current_sort == 'quantity' %}selected{% endif %}>Cantidad (Menor a Mayor)</option>
        <option value="-quantity" {% if current_sort == '-quantity' %}selected{% endif %}>Cantidad (Mayor a Menor)</option>
        <option value="type" {% if current_sort == 'type' %}selected{% endif %}>Tipo (A-Z)</option>
        <option value="-type" {% if current_sort == '-type' %}selected{% endif %}>Tipo (Z-A)</option>
      </select>
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-primary" style="display: none;">Buscar</button>
    </div>
    {% if search_query or type_filter %}
    <div class="col-auto">
      <a href="{% url 'movement_list' %}" class="btn btn-secondary">Limpiar</a>
    </div>
    {% endif %}
  </form>
</div>

<!-- Tabla de Movimientos -->
<div class="card">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-striped table-hover mb-0">
        <thead>
          <tr>
            <th>Producto</th>
            <th>SKU</th>
            <th>Cantidad</th>
            <th>Tipo</th>
            <th>Zona Origen</th>
            <th>Zona Destino</th>
            <th>Fecha</th>
            <th>Realizado por</th>
            <th>Motivo</th>
          </tr>
        </thead>
        <tbody id="movement-list-body">
          {% include 'gestion/includes/movement_table_body.html' %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Paginador -->
{% if page_obj.paginator.num_pages > 1 %}
<nav class="mt-4">
  <ul class="pagination justify-content-center">
    {% if page_obj.has_previous %}
    <li class="page-item">
      <a class="page-link" href="?page=1&q={{ search_query }}&type={{ type_filter }}&sort={{ current_sort }}">&laquo;</a>
    </li>
    <li class="page-item">
      <a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ search_query }}&type={{ type_filter }}&sort={{ current_sort }}">Anterior</a>
    </li>
    {% endif %}

    <li class="page-item active" aria-current="page">
      <span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
    </li>

    {% if page_obj.has_next %}
    <li class="page-item">
      <a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ search_query }}&type={{ type_filter }}&sort={{ current_sort }}">Siguiente</a>
    </li>
    <li class="page-item">
      <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&q={{ search_query }}&type={{ type_filter }}&sort={{ current_sort }}">&raquo;</a>
    </li>
    {% endif %}
  </ul>
</nav>
{% endif %}

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.getElementById('movement-live-search-input');
    const typeFilter = document.getElementById('movement-type-filter');
    const resultsBody = document.getElementById('movement-list-body');
    const searchURL = "{% url 'api_search_movements_live' %}";
    const searchForm = searchInput.closest('form');

    if (searchForm) {
      searchForm.addEventListener('submit', (e) => {
        e.preventDefault();
      });
    }
    
    const performSearch = async (query, type) => {
      try {
        const url = `${searchURL}?q=${encodeURIComponent(query)}&type=${encodeURIComponent(type || '')}`;
        const response = await fetch(url);
        
        if (response.headers.get('content-type') === 'application/json') {
          const data = await response.json();
          if (response.ok) {
            resultsBody.innerHTML = data.html;
          } else {
            console.error("Error en la búsqueda:", data);
            resultsBody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Error al cargar resultados.</td></tr>';
          }
        } else {
          console.error("La respuesta del servidor no fue JSON. Código:", response.status);
          resultsBody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Error de comunicación con el servidor.</td></tr>';
        }
      } catch (error) {
        console.error("Error de red o procesamiento:", error);
        resultsBody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Error de conexión.</td></tr>';
      }
    };

    let debounceTimer;
    searchInput.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') return;
      clearTimeout(debounceTimer);
      const query = e.target.value.trim();
      const type = typeFilter ? typeFilter.value : '';
      debounceTimer = setTimeout(() => {
        if (query.length >= 1 || query.length === 0) {
          performSearch(query, type);
        }
      }, 300);
    });

    if (typeFilter) {
      typeFilter.addEventListener('change', () => {
        const query = searchInput.value.trim();
        const type = typeFilter.value;
        performSearch(query, type);
      });
    }
  });
</script>
{% endblock %}

