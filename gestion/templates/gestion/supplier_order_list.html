<!-- gestion/templates/gestion/supplier_order_list.html -->
{% extends 'gestion/base.html' %}
<!-- -->
{% block title %}Órdenes a Proveedores{% endblock %}
<!-- -->
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Órdenes a Proveedores</h2>
  <div>
    <a href="{% url 'export_supplier_orders_excel' %}{% if search_query or status_filter %}?{% if search_query %}q={{ search_query|urlencode }}{% endif %}{% if search_query and status_filter %}&{% endif %}{% if status_filter %}status={{ status_filter|urlencode }}{% endif %}{% endif %}" class="btn btn-success me-2">
      Exportar a Excel
    </a>
    <a href="{% url 'supplier_order_create' %}" class="btn btn-primary">
      + Nueva Orden
    </a>
  </div>
</div>

<!-- Filtros y Buscador -->
<div class="card card-body mb-3">
  <form method="GET" action="" class="row g-3 align-items-center">
    <div class="col-auto">
      <input
        type="text"
        name="q"
        id="supplier-order-live-search-input"
        class="form-control"
        value="{{ search_query }}"
        placeholder="Buscar por proveedor o ID..."
      />
    </div>
    <div class="col-auto">
      <select name="status" id="supplier-order-status-filter" class="form-select">
        <option value="">Todos los estados</option>
        <option value="PENDING" {% if status_filter == 'PENDING' %}selected{% endif %}>Pendiente</option>
        <option value="RECEIVED" {% if status_filter == 'RECEIVED' %}selected{% endif %}>Recibida</option>
        <option value="CANCELLED" {% if status_filter == 'CANCELLED' %}selected{% endif %}>Cancelada</option>
      </select>
    </div>
    <div class="col-auto">
      <label for="sort-select" class="form-label mb-0">Ordenar por:</label>
    </div>
    <div class="col-auto">
      <select id="sort-select" name="sort" class="form-select" onchange="this.form.submit()">
        <option value="-date" {% if current_sort == '-date' or not current_sort %}selected{% endif %}>Fecha (Más Reciente)</option>
        <option value="date" {% if current_sort == 'date' %}selected{% endif %}>Fecha (Más Antigua)</option>
        <option value="supplier" {% if current_sort == 'supplier' %}selected{% endif %}>Proveedor (A-Z)</option>
        <option value="-supplier" {% if current_sort == '-supplier' %}selected{% endif %}>Proveedor (Z-A)</option>
        <option value="status" {% if current_sort == 'status' %}selected{% endif %}>Estado (A-Z)</option>
        <option value="-status" {% if current_sort == '-status' %}selected{% endif %}>Estado (Z-A)</option>
        <option value="id" {% if current_sort == 'id' %}selected{% endif %}>ID (Menor a Mayor)</option>
        <option value="-id" {% if current_sort == '-id' %}selected{% endif %}>ID (Mayor a Menor)</option>
      </select>
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-primary" style="display: none;">Buscar</button>
    </div>
    {% if search_query or status_filter %}
    <div class="col-auto">
      <a href="{% url 'supplier_order_list' %}" class="btn btn-secondary">Limpiar</a>
    </div>
    {% endif %}
  </form>
</div>

<!-- Tabla de Órdenes -->
<div class="card">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-striped table-hover mb-0">
        <thead>
          <tr>
            <th>ID</th>
            <th>Proveedor</th>
            <th>Bodega</th>
            <th>Zona</th>
            <th>Items</th>
            <th>Fecha</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="supplier-order-list-body">
          {% include 'gestion/includes/supplier_order_table_body.html' %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Paginador -->
{% if page_obj.paginator.num_pages > 1 %}
<nav class="mt-4">
  <ul class="pagination justify-content-center">
    {% if page_obj.has_previous %}
    <li class="page-item">
      <a class="page-link" href="?page=1&q={{ search_query }}&status={{ status_filter }}&sort={{ current_sort }}">&laquo;</a>
    </li>
    <li class="page-item">
      <a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ search_query }}&status={{ status_filter }}&sort={{ current_sort }}">Anterior</a>
    </li>
    {% endif %}

    <li class="page-item active" aria-current="page">
      <span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
    </li>

    {% if page_obj.has_next %}
    <li class="page-item">
      <a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ search_query }}&status={{ status_filter }}&sort={{ current_sort }}">Siguiente</a>
    </li>
    <li class="page-item">
      <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&q={{ search_query }}&status={{ status_filter }}&sort={{ current_sort }}">&raquo;</a>
    </li>
    {% endif %}
  </ul>
</nav>
{% endif %}

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.getElementById('supplier-order-live-search-input');
    const statusFilter = document.getElementById('supplier-order-status-filter');
    const resultsBody = document.getElementById('supplier-order-list-body');
    const searchURL = "{% url 'api_search_supplier_orders_live_list' %}";
    const searchForm = searchInput.closest('form');

    if (searchForm) {
      searchForm.addEventListener('submit', (e) => {
        e.preventDefault();
      });
    }
    
    const performSearch = async (query, status) => {
      try {
        const url = `${searchURL}?q=${encodeURIComponent(query)}&status=${encodeURIComponent(status || '')}`;
        const response = await fetch(url);
        
        if (response.headers.get('content-type') === 'application/json') {
          const data = await response.json();
          if (response.ok) {
            resultsBody.innerHTML = data.html;
          } else {
            console.error("Error en la búsqueda:", data);
            resultsBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error al cargar resultados.</td></tr>';
          }
        } else {
          console.error("La respuesta del servidor no fue JSON. Código:", response.status);
          resultsBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error de comunicación con el servidor.</td></tr>';
        }
      } catch (error) {
        console.error("Error de red o procesamiento:", error);
        resultsBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error de conexión.</td></tr>';
      }
    };

    let debounceTimer;
    searchInput.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') return;
      clearTimeout(debounceTimer);
      const query = e.target.value.trim();
      const status = statusFilter ? statusFilter.value : '';
      debounceTimer = setTimeout(() => {
        if (query.length >= 1 || query.length === 0) {
          performSearch(query, status);
        }
      }, 300);
    });

    if (statusFilter) {
      statusFilter.addEventListener('change', () => {
        const query = searchInput.value.trim();
        const status = statusFilter.value;
        performSearch(query, status);
      });
    }
  });
</script>
{% endblock %}

