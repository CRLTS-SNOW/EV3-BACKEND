<!-- gestion/templates/gestion/sale_form.html -->
{% extends 'gestion/base.html' %}
<!-- -->
{% block title %}Punto de Venta (POS){% endblock %}
<!-- -->
{% block content %}
<div class="row">
  <!-- Columna Izquierda: Lista de Productos, Buscador y Carrito -->
  <div class="col-lg-8">
    <h2 class="mb-3">Nueva Venta</h2>

    <!-- Tabs para cambiar entre Lista y Búsqueda -->
    <ul class="nav nav-tabs mb-3" id="productTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list" type="button" role="tab">
          Lista de Productos
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="search-tab" data-bs-toggle="tab" data-bs-target="#search" type="button" role="tab">
          Buscar Producto
        </button>
      </li>
    </ul>

    <!-- Contenido de los Tabs -->
    <div class="tab-content mb-3" id="productTabsContent">
      <!-- Tab 1: Lista de Productos -->
      <div class="tab-pane fade show active" id="list" role="tabpanel">
        <div class="card">
          <div class="card-body" style="max-height: 400px; overflow-y: auto;">
            <div class="row g-2">
              {% for product in products_with_stock %}
              <div class="col-md-4 col-sm-6">
                <div class="card product-card h-100" 
                     data-product-id="{{ product.id }}"
                     data-product-name="{{ product.name }}"
                     data-product-price="{{ product.price }}"
                     data-product-stock="{{ product.stock }}"
                     style="cursor: pointer; transition: all 0.2s;"
                     onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.2)';"
                     onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                  <div class="card-body text-center">
                    <h6 class="card-title mb-2">{{ product.name }}</h6>
                    <p class="text-muted small mb-1">SKU: {{ product.sku }}</p>
                    <p class="fw-bold text-primary mb-1">${{ product.price }}</p>
                    <span class="badge {% if product.stock > 0 %}bg-success{% else %}bg-danger{% endif %}">
                      Stock: {{ product.stock }}
                    </span>
                  </div>
                </div>
              </div>
              {% empty %}
              <div class="col-12">
                <p class="text-center text-muted">No hay productos con stock disponible.</p>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <!-- Tab 2: Buscador -->
      <div class="tab-pane fade" id="search" role="tabpanel">
        <div class="mb-3">
          <label for="product-search" class="form-label">Buscar Producto (por nombre o SKU):</label>
          <input
            type="text"
            id="product-search"
            class="form-control"
            placeholder="Ej: Alfajor..."
          />
          <div
            id="search-results"
            class="list-group mt-2"
            style="max-height: 300px; overflow-y: auto;"
          >
            <!-- Los resultados de la búsqueda irán aquí -->
          </div>
        </div>
      </div>
    </div>

    <!-- Carrito de Compras -->
    <div class="card shadow-sm mt-4">
      <div class="card-header">
        <h5>Carrito de Compras</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table mb-0" id="cart-table">
            <thead>
              <tr>
                <th>Producto</th>
                <th>Precio</th>
                <th>Cantidad</th>
                <th>Total</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="cart-body">
              <!-- Los productos añadidos irán aquí -->
            </tbody>
          </table>
        </div>
        <div class="mt-3 text-end">
          <h4>Total Venta: <span id="cart-total" class="text-primary">$0</span></h4>
        </div>
      </div>
    </div>
  </div>

  <!-- Columna Derecha: Cliente y Finalizar -->
  <div class="col-lg-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="mb-3">Cliente</h5>
        <select id="client-select" class="form-select mb-3">
          <option value="">Cliente Varios (Boleta)</option>
          {% for client in clients %}
          <option value="{{ client.id }}">
            {{ client.name }} ({{ client.rut|default:"N/A" }})
          </option>
          {% endfor %}
        </select>

        <h5 class="mt-4 mb-3">Finalizar Venta</h5>
        <button id="btn-process-sale" class="btn btn-success w-100 btn-lg">
          <i class="bi bi-cash-stack"></i> Procesar Venta
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.getElementById("product-search");
    const searchResults = document.getElementById("search-results");
    const cartBody = document.getElementById("cart-body");
    const cartTotalEl = document.getElementById("cart-total");
    const clientSelect = document.getElementById("client-select");
    const btnProcessSale = document.getElementById("btn-process-sale");
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || "{{ csrf_token }}";

    let cart = []; // Nuestro carrito en memoria
    let searchTimer;

    // --- 1. LISTA DE PRODUCTOS (Click en las tarjetas) ---
    document.querySelectorAll('.product-card').forEach(card => {
      card.addEventListener('click', function() {
        const product = {
          id: parseInt(this.dataset.productId),
          name: this.dataset.productName,
          price: parseFloat(this.dataset.productPrice),
          stock: parseInt(this.dataset.productStock)
        };
        addProductToCart(product);
      });
    });

    // --- 2. BUSCADOR DE PRODUCTOS (con debounce) ---
    if (searchInput) {
      searchInput.addEventListener("keyup", () => {
        clearTimeout(searchTimer);
        const query = searchInput.value;

        if (query.length < 2) {
          searchResults.innerHTML = "";
          return;
        }

        searchTimer = setTimeout(async () => {
          try {
            const response = await fetch(`{% url 'api_search_products_sale' %}?q=${encodeURIComponent(query)}`);
            const data = await response.json();

            searchResults.innerHTML = "";
            if (data.status === "success" && data.products.length > 0) {
              data.products.forEach((product) => {
                searchResults.appendChild(createSearchResultItem(product));
              });
            } else {
              searchResults.innerHTML = '<div class="list-group-item text-muted text-center">Sin resultados</div>';
            }
          } catch (error) {
            console.error("Error buscando:", error);
          }
        }, 300);
      });
    }

    function createSearchResultItem(product) {
      const item = document.createElement("div");
      item.className = "list-group-item list-group-item-action d-flex justify-content-between align-items-center";
      item.style.cursor = "pointer";

      let stockClass = product.stock > 0 ? "text-success" : "text-danger";
      item.innerHTML = `
        <div>
          <strong>${product.name}</strong><br>
          <small class="text-muted">SKU: ${product.sku}</small><br>
          <span class="${stockClass}">Stock: ${product.stock}</span>
        </div>
        <span class="badge bg-primary rounded-pill">$${parseFloat(product.price).toFixed(0)}</span>
      `;

      item.addEventListener("click", (e) => {
        e.preventDefault();
        if (product.stock > 0) {
          addProductToCart({
            id: parseInt(product.id),
            name: product.name,
            price: parseFloat(product.price),
            stock: parseInt(product.stock)
          });
          searchInput.value = "";
          searchResults.innerHTML = "";
        } else {
          Swal.fire("Error", "Este producto no tiene stock disponible.", "error");
        }
      });
      return item;
    }

    // --- 3. LÓGICA DEL CARRITO ---
    function addProductToCart(product) {
      const existingItem = cart.find((item) => item.id === product.id);

      if (existingItem) {
        if (existingItem.quantity < existingItem.stock) {
          existingItem.quantity++;
        } else {
          Swal.fire(
            "Límite de Stock",
            `Ya tienes el máximo (${existingItem.stock}) de este producto en el carrito.`,
            "warning"
          );
          return;
        }
      } else {
        cart.push({
          id: product.id,
          name: product.name,
          price: product.price,
          stock: product.stock,
          quantity: 1,
        });
      }
      renderCart();
      
      // Mostrar notificación
      Swal.fire({
        icon: "success",
        title: "Producto agregado",
        text: `${product.name} agregado al carrito`,
        timer: 1000,
        showConfirmButton: false
      });
    }

    function renderCart() {
      cartBody.innerHTML = "";
      let totalVenta = 0;

      if (cart.length === 0) {
        cartBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">El carrito está vacío</td></tr>';
        cartTotalEl.textContent = "$0";
        return;
      }

      cart.forEach((item, index) => {
        const row = document.createElement("tr");
        const totalItem = item.price * item.quantity;
        totalVenta += totalItem;

        row.innerHTML = `
          <td>${item.name}</td>
          <td>$${item.price.toFixed(0)}</td>
          <td>
            <input type="number" class="form-control form-control-sm" 
                   style="width: 80px;"
                   value="${item.quantity}" min="1" max="${item.stock}" 
                   data-index="${index}" onchange="updateCartQuantity(this)">
          </td>
          <td>$${totalItem.toFixed(0)}</td>
          <td>
            <button class="btn btn-danger btn-sm" 
                    data-index="${index}" onclick="removeCartItem(this)">
              <i class="bi bi-x"></i> Eliminar
            </button>
          </td>
        `;
        cartBody.appendChild(row);
      });

      cartTotalEl.textContent = `$${totalVenta.toFixed(0)}`;
    }

    window.updateCartQuantity = (input) => {
      const index = input.dataset.index;
      let newQuantity = parseInt(input.value);
      const item = cart[index];

      if (newQuantity > item.stock) {
        Swal.fire("Error", `Stock insuficiente. Máximo disponible: ${item.stock}`, "error");
        newQuantity = item.stock;
        input.value = item.stock;
      }
      if (newQuantity < 1) {
        newQuantity = 1;
        input.value = 1;
      }
      item.quantity = newQuantity;
      renderCart();
    };

    window.removeCartItem = (button) => {
      const index = button.dataset.index;
      const itemName = cart[index].name;
      cart.splice(index, 1);
      renderCart();
      Swal.fire("Eliminado", `${itemName} eliminado del carrito`, "info");
    };

    // Inicializar carrito vacío
    renderCart();

    // --- 4. PROCESAR VENTA (AJAX) ---
    btnProcessSale.addEventListener("click", async () => {
      if (cart.length === 0) {
        Swal.fire("Error", "El carrito está vacío.", "error");
        return;
      }

      const saleData = {
        client_id: clientSelect.value || null,
        cart: cart.map((item) => ({ id: item.id, quantity: item.quantity })),
      };

      try {
        const response = await fetch(`{% url 'api_process_sale' %}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken,
          },
          body: JSON.stringify(saleData),
        });

        const result = await response.json();

        if (response.ok) {
          Swal.fire({
            title: "¡Venta Exitosa!",
            text: result.message,
            icon: "success",
            confirmButtonText: "Aceptar"
          }).then(() => {
            cart = [];
            renderCart();
            clientSelect.value = "";
            // Recargar la página para actualizar el stock
            window.location.reload();
          });
        } else {
          Swal.fire({
            title: "Error en la Venta",
            html: result.errors,
            icon: "error"
          });
        }
      } catch (error) {
        console.error("Error procesando venta:", error);
        Swal.fire("Error", "No se pudo conectar con el servidor.", "error");
      }
    });
  });
</script>
{% endblock %}
