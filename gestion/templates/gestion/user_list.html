<!-- gestion/templates/gestion/user_list.html -->
{% extends 'gestion/base.html' %}
<!-- -->
{% block title %}Gestión de Usuarios{% endblock %}
<!-- -->
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Gestión de Usuarios</h2>
  <div>
    <a href="{% url 'export_users_excel' %}{% if search_query %}?q={{ search_query|urlencode }}{% endif %}" class="btn btn-success me-2">
      Exportar a Excel
    </a>
    <a href="{% url 'user_create' %}" class="btn btn-primary">
      + Nuevo Usuario
    </a>
  </div>
</div>

<!-- Buscador -->
<div class="card card-body mb-3">
  <form method="GET" action="" class="row g-3 align-items-center">
    <div class="col-auto">
      <input
        type="text"
        name="q"
        id="user-live-search-input"
        class="form-control"
        value="{{ search_query }}"
        placeholder="Buscar por nombre de usuario, email..."
      />
    </div>
    <div class="col-auto">
      <label for="sort-select" class="form-label mb-0">Ordenar por:</label>
    </div>
    <div class="col-auto">
      <select id="sort-select" name="sort" class="form-select" onchange="this.form.submit()">
        <option value="username" {% if current_sort == 'username' or not current_sort %}selected{% endif %}>Usuario (A-Z)</option>
        <option value="-username" {% if current_sort == '-username' %}selected{% endif %}>Usuario (Z-A)</option>
        <option value="email" {% if current_sort == 'email' %}selected{% endif %}>Email (A-Z)</option>
        <option value="-email" {% if current_sort == '-email' %}selected{% endif %}>Email (Z-A)</option>
        <option value="first_name" {% if current_sort == 'first_name' %}selected{% endif %}>Nombre (A-Z)</option>
        <option value="-first_name" {% if current_sort == '-first_name' %}selected{% endif %}>Nombre (Z-A)</option>
        <option value="last_name" {% if current_sort == 'last_name' %}selected{% endif %}>Apellido (A-Z)</option>
        <option value="-last_name" {% if current_sort == '-last_name' %}selected{% endif %}>Apellido (Z-A)</option>
      </select>
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-primary" style="display: none;">Buscar</button>
    </div>
    {% if search_query %}
    <div class="col-auto">
      <a href="{% url 'user_list' %}" class="btn btn-secondary">Limpiar</a>
    </div>
    {% endif %}
  </form>
</div>

<!-- Tabla de Usuarios -->
<div class="card">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-striped table-hover mb-0">
        <thead>
          <tr>
            <th>Usuario</th>
            <th>Nombre Completo</th>
            <th>Email</th>
            <th>Rol</th>
            <th>Bodega Asignada</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="user-list-body">
          {% include 'gestion/includes/user_table_body.html' %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Paginador -->
{% if page_obj.paginator.num_pages > 1 %}
<nav class="mt-4">
  <ul class="pagination justify-content-center">
    {% if page_obj.has_previous %}
    <li class="page-item">
      <a class="page-link" href="?page=1&q={{ search_query }}&sort={{ current_sort }}">&laquo;</a>
    </li>
    <li class="page-item">
      <a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ search_query }}&sort={{ current_sort }}">Anterior</a>
    </li>
    {% endif %}

    <li class="page-item active" aria-current="page">
      <span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
    </li>

    {% if page_obj.has_next %}
    <li class="page-item">
      <a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ search_query }}&sort={{ current_sort }}">Siguiente</a>
    </li>
    <li class="page-item">
      <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&q={{ search_query }}&sort={{ current_sort }}">&raquo;</a>
    </li>
    {% endif %}
  </ul>
</nav>
{% endif %}

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.getElementById('user-live-search-input');
    const resultsBody = document.getElementById('user-list-body');
    const searchURL = "{% url 'api_search_users_live' %}";
    const searchForm = searchInput.closest('form');

    if (searchForm) {
      searchForm.addEventListener('submit', (e) => {
        e.preventDefault();
      });
    }
    
    const performSearch = async (query) => {
      try {
        const url = `${searchURL}?q=${encodeURIComponent(query)}`;
        const response = await fetch(url);
        
        if (response.headers.get('content-type') === 'application/json') {
          const data = await response.json();
          if (response.ok) {
            resultsBody.innerHTML = data.html;
          } else {
            console.error("Error en la búsqueda:", data);
            resultsBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error al cargar resultados.</td></tr>';
          }
        } else {
          console.error("La respuesta del servidor no fue JSON. Código:", response.status);
          resultsBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error de comunicación con el servidor.</td></tr>';
        }
      } catch (error) {
        console.error("Error de red o procesamiento:", error);
        resultsBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error de conexión.</td></tr>';
      }
    };

    let debounceTimer;
    searchInput.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') return;
      clearTimeout(debounceTimer);
      const query = e.target.value.trim();
      debounceTimer = setTimeout(() => {
        if (query.length >= 1 || query.length === 0) {
          performSearch(query);
        }
      }, 300);
    });
  });

  // SweetAlert2 para eliminación de usuarios
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('delete-user-btn')) {
      e.preventDefault();
      const btn = e.target;
      const userId = btn.dataset.userId;
      const username = btn.dataset.username;
      const deleteUrl = btn.getAttribute('href');

      Swal.fire({
        title: '¿Estás seguro?',
        text: `¿Está seguro que desea eliminar al usuario "${username}"?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar',
        reverseButtons: true
      }).then((result) => {
        if (result.isConfirmed) {
          // Crear un formulario y enviarlo
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = deleteUrl;
          
          // Obtener el token CSRF de los cookies
          const csrftoken = getCookie('csrftoken');
          if (csrftoken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrftoken;
            form.appendChild(csrfInput);
          }
          
          document.body.appendChild(form);
          form.submit();
        }
      });
    }
  });

  // Función para obtener cookie
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
{% endblock %}

