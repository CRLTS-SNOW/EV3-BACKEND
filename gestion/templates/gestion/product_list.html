{% extends 'gestion/base.html' %}
{% block title %}Inventario de Productos{% endblock %} 
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Inventario de Productos</h2>
    <div>
        {% if user.is_superuser or user.profile.role == 'admin' or user.profile.role == 'bodega' %}
        <a href="{% url 'export_movements_excel' %}" class="btn btn-success me-2">
            Exportar Movimientos
        </a>
        {% endif %}
        <a href="{% url 'export_products_excel' %}" class="btn btn-success">
            Exportar Productos
        </a>
    </div>
</div>

<div class="card card-body mb-3">
    <form method="GET" action="" class="row g-3 align-items-center">
        <div class="col-auto">
            <input
                type="text"
                id="live-search-input" name="q"
                class="form-control"
                value="{{ search_query }}"
                placeholder="Buscar por nombre, SKU o proveedor..."
            />
        </div>
        <div class="col-auto">
            <label for="sort-select" class="form-label mb-0">Ordenar por:</label>
        </div>
        <div class="col-auto">
            <select id="sort-select" name="sort" class="form-select" onchange="this.form.submit()">
                <option value="name" {% if current_sort == 'name' %}selected{% endif %}>Nombre (A-Z)</option>
                <option value="-name" {% if current_sort == '-name' %}selected{% endif %}>Nombre (Z-A)</option>
                <option value="stock" {% if current_sort == 'stock' %}selected{% endif %}>Stock (Menor a Mayor)</option>
                <option value="-stock" {% if current_sort == '-stock' %}selected{% endif %}>Stock (Mayor a Menor)</option>
                <option value="price" {% if current_sort == 'price' %}selected{% endif %}>Precio (Menor a Mayor)</option>
                <option value="-price" {% if current_sort == '-price' %}selected{% endif %}>Precio (Mayor a Menor)</option>
                <option value="sku" {% if current_sort == 'sku' %}selected{% endif %}>SKU (A-Z)</option>
                <option value="-sku" {% if current_sort == '-sku' %}selected{% endif %}>SKU (Z-A)</option>
            </select>
        </div>
        <div class="col-auto">
            <label for="per-page-select" class="form-label mb-0">Productos por página:</label>
        </div>
        <div class="col-auto">
            <select id="per-page-select" name="per_page" class="form-select" onchange="this.form.submit()">
                <option value="10" {% if per_page == '10' %}selected{% endif %}>10</option>
                <option value="20" {% if per_page == '20' or not per_page %}selected{% endif %}>20</option>
                <option value="30" {% if per_page == '30' %}selected{% endif %}>30</option>
            </select>
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-primary" style="display: none;">Buscar</button>
        </div>
    </form>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Productos en Inventario</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th><a href="?sort=name&q={{ search_query }}&per_page={{ per_page }}" class="sort-link" data-sort="name">Nombre</a></th>
                                <th><a href="?sort=sku&q={{ search_query }}&per_page={{ per_page }}" class="sort-link" data-sort="sku">SKU</a></th>
                                <th>
                                    <a href="?sort=supplier__name&q={{ search_query }}&per_page={{ per_page }}" class="sort-link" data-sort="supplier__name">Proveedor</a>
                                </th>
                                <th><a href="?sort=price&q={{ search_query }}&per_page={{ per_page }}" class="sort-link" data-sort="price">Precio</a></th>
                                <th>Stock Total</th>
                            </tr>
                        </thead>
                        <tbody id="product-list-body">
                            {% include 'gestion/includes/product_table_body.html' %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {% if page_obj.paginator.num_pages > 1 and not search_query %}
        <nav class="mb-4" id="pagination-nav">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a
                        class="page-link"
                        href="?page=1&q={{ search_query }}&sort={{ current_sort }}&per_page={{ per_page }}"
                        >&laquo;</a
                    >
                </li>
                <li class="page-item">
                    <a
                        class="page-link"
                        href="?page={{ page_obj.previous_page_number }}&q={{ search_query }}&sort={{ current_sort }}&per_page={{ per_page }}"
                        >Anterior</a
                    >
                </li>
                {% endif %}

                <li class="page-item active" aria-current="page">
                    <span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
                </li>

                {% if page_obj.has_next %}
                <li class="page-item">
                    <a
                        class="page-link"
                        href="?page={{ page_obj.next_page_number }}&q={{ search_query }}&sort={{ current_sort }}&per_page={{ per_page }}"
                        >Siguiente</a
                    >
                </li>
                <li class="page-item">
                    <a
                        class="page-link"
                        href="?page={{ page_obj.paginator.num_pages }}&q={{ search_query }}&sort={{ current_sort }}&per_page={{ per_page }}"
                        >&raquo;</a
                    >
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>

    {% if movement_form %}
    <div class="col-lg-4">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0">Transferir Stock</h5>
            </div>
            <div class="card-body">
                <form id="movementForm">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label for="{{ movement_form.product.id_for_label }}" class="form-label">Producto:</label>
                        {{ movement_form.product }}
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label
                                for="{{ movement_form.origin_zone.id_for_label }}"
                                class="form-label"
                                >Zona Origen:</label
                            >
                            {{ movement_form.origin_zone }}
                            <div
                                class="form-text"
                                id="stock-display"
                                style="font-weight: bold; color: #007bff"
                            ></div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label
                                for="{{ movement_form.destination_zone.id_for_label }}"
                                class="form-label"
                                >Zona Destino:</label
                            >
                            {{ movement_form.destination_zone }}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ movement_form.quantity.id_for_label }}" class="form-label">Cantidad:</label>
                        {{ movement_form.quantity }}
                    </div>

                    <div class="mb-3">
                        <label for="{{ movement_form.reason.id_for_label }}" class="form-label">Motivo (Opcional):</label>
                        {{ movement_form.reason }}
                    </div>

                    <button type="submit" class="btn btn-primary w-100">
                        Realizar Transferencia
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %} 

{% block scripts %}
{% if movement_form %}
<script>
    // --- Referencias a los elementos del DOM ---
    const productSelect = document.getElementById("{{ movement_form.product.id_for_label }}");
    const originZoneSelect = document.getElementById("{{ movement_form.origin_zone.id_for_label }}");
    const destZoneSelect = document.getElementById("{{ movement_form.destination_zone.id_for_label }}");
    const stockDisplay = document.getElementById("stock-display");
    const form = document.getElementById("movementForm");

    let productStockInfo = [];
    let allZonesInfo = [];

    // --- Función para resetear un dropdown ---
    function resetSelect(selectElement, defaultText) {
        selectElement.innerHTML = "";
        const defaultOption = new Option(defaultText, "");
        defaultOption.disabled = true;
        defaultOption.selected = true;
        selectElement.add(defaultOption);
    }

    // --- Lógica de Carga Inicial ---
    document.addEventListener("DOMContentLoaded", async () => {
        resetSelect(originZoneSelect, "Seleccione un producto primero");
        resetSelect(destZoneSelect, "Seleccione un producto primero");

        try {
            const response = await fetch("{% url 'api_get_all_zones' %}");
            const data = await response.json();
            if (data.status === "success") {
                allZonesInfo = data.zones;
            }
        } catch (error) {
            console.error("Error cargando zonas:", error);
        }
    });

    // --- 1. CUANDO EL USUARIO SELECCIONA UN PRODUCTO ---
    productSelect.addEventListener("change", async () => {
        const productId = productSelect.value;

        resetSelect(originZoneSelect, "Cargando zonas...");
        resetSelect(destZoneSelect, "Seleccione zona de origen");
        stockDisplay.textContent = "";

        if (!productId) {
            resetSelect(originZoneSelect, "Seleccione un producto");
            return;
        }

        try {
            const response = await fetch(`/app/api/product-stock/${productId}/`);
            const data = await response.json();

            if (data.status === "success" && data.stock_info.length > 0) {
                productStockInfo = data.stock_info;

                resetSelect(originZoneSelect, "Seleccione zona de origen");
                data.stock_info.forEach((item) => {
                    originZoneSelect.add(new Option(item.zone_name, item.zone_id));
                });
            } else {
                productStockInfo = [];
                resetSelect(originZoneSelect, "Producto sin stock");
            }
        } catch (error) {
            console.error("Error:", error);
            resetSelect(originZoneSelect, "Error al cargar zonas");
        }
    });

    // --- 2. CUANDO EL USUARIO SELECCIONA ZONA DE ORIGEN ---
    originZoneSelect.addEventListener("change", () => {
        const selectedZoneId = originZoneSelect.value;

        const stockInfo = productStockInfo.find(
            (item) => item.zone_id == selectedZoneId
        );
        if (stockInfo) {
            stockDisplay.textContent = `Stock disponible: ${stockInfo.stock}`;
        } else {
            stockDisplay.textContent = "";
        }

        resetSelect(destZoneSelect, "Seleccione zona de destino");
        allZonesInfo.forEach((zone) => {
            if (zone.id != selectedZoneId) {
                destZoneSelect.add(new Option(zone.name, zone.id));
            }
        });
    });

    // --- 3. CUANDO SE ENVÍA EL FORMULARIO (AJAX) ---
    form.addEventListener("submit", async function (e) {
        e.preventDefault();

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        const response = await fetch("{% url 'product_movement' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": data.csrfmiddlewaretoken,
            },
            body: JSON.stringify(data),
        });

        const result = await response.json();

        if (response.ok) {
            Swal.fire({
                title: "¡Éxito!",
                text: result.message,
                icon: "success",
            }).then(() => {
                form.reset();
                resetSelect(originZoneSelect, "Seleccione un producto primero");
                resetSelect(destZoneSelect, "Seleccione un producto primero");
                stockDisplay.textContent = "";
                // Recargar la página para actualizar el stock
                location.reload();
            });
        } else {
            Swal.fire({
                title: "Error de Validación",
                html: result.errors,
                icon: "error",
            });
        }
    });
</script>
{% endif %}

<script>
    document.addEventListener("DOMContentLoaded", () => {
        // Referencias a elementos
        const searchInput = document.getElementById('live-search-input');
        const resultsBody = document.getElementById('product-list-body');
        const searchURL = "{% url 'api_search_products_live' %}";
        const searchForm = searchInput.closest('form'); // Captura el formulario

        // Prevenimos que "Enter" recargue la página
        if (searchForm) {
            searchForm.addEventListener('submit', (e) => {
                e.preventDefault(); // Detiene el envío del formulario
            });
        }
        
        // Función para actualizar la tabla
        const performSearch = async (query, sort_by = 'name') => {
            try {
                // Obtiene el orden actual o usa 'name' por defecto
                const currentSort = new URLSearchParams(window.location.search).get('sort') || sort_by;
                const url = `${searchURL}?q=${encodeURIComponent(query)}&sort=${currentSort}`;
                
                const response = await fetch(url);
                
                if (response.headers.get('content-type') === 'application/json') {
                    const data = await response.json();
                    if (response.ok) {
                        resultsBody.innerHTML = data.html;
                        
                        // Ocultar paginador cuando hay búsqueda activa
                        const paginationNav = document.getElementById('pagination-nav');
                        if (paginationNav) {
                            if (query.trim().length > 0) {
                                paginationNav.style.display = 'none';
                            } else {
                                paginationNav.style.display = 'block';
                            }
                        }
                    } else {
                        console.error("Error en la búsqueda:", data);
                        resultsBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error al cargar resultados.</td></tr>';
                    }
                } else {
                    console.error("La respuesta del servidor no fue JSON. Código:", response.status);
                    resultsBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error de comunicación con el servidor.</td></tr>';
                }
            } catch (error) {
                console.error("Error de red o procesamiento:", error);
                resultsBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error de conexión.</td></tr>';
            }
        };
        
        // Manejar cambio en el selector de productos por página
        const perPageSelect = document.getElementById('per-page-select');
        if (perPageSelect) {
            perPageSelect.addEventListener('change', function() {
                // Obtener parámetros actuales de la URL
                const urlParams = new URLSearchParams(window.location.search);
                urlParams.set('per_page', this.value);
                urlParams.set('page', '1'); // Volver a la primera página cuando cambia el tamaño
                
                // Recargar la página con los nuevos parámetros
                window.location.href = window.location.pathname + '?' + urlParams.toString();
            });
        }

        // LÓGICA DE BÚSQUEDA MIENTRAS SE ESCRIBE
        let debounceTimer;

        searchInput.addEventListener('keyup', (e) => {
            // Evitamos que la tecla "Enter" dispare la búsqueda (ya lo previene el 'submit')
            if (e.key === 'Enter') return; 

            clearTimeout(debounceTimer);
            const query = e.target.value.trim();
            
            debounceTimer = setTimeout(() => {
                // Si hay búsqueda, mostrar todos los resultados (sin paginación)
                // Si no hay búsqueda, recargar la página para mostrar paginación normal
                if (query.length >= 1) {
                    performSearch(query);
                } else if (query.length === 0) {
                    // Si se limpia la búsqueda, recargar para mostrar paginación
                    // Mantener el parámetro per_page si existe
                    const urlParams = new URLSearchParams(window.location.search);
                    const perPage = urlParams.get('per_page') || '20';
                    window.location.href = '{% url "product_list" %}?per_page=' + perPage;
                }
            }, 300); // 300ms de retraso
        });
        
        // Ocultar paginador si hay búsqueda al cargar la página
        window.addEventListener('load', () => {
            const searchQuery = searchInput.value.trim();
            const paginationNav = document.getElementById('pagination-nav');
            if (paginationNav && searchQuery.length > 0) {
                paginationNav.style.display = 'none';
            }
        });
        
        // Lógica para los enlaces de ordenar
        const tableContainer = document.querySelector('.table');
        if (tableContainer) {
            tableContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('sort-link')) {
                    e.preventDefault();
                    
                    const sortKey = e.target.dataset.sort;
                    const currentQuery = searchInput.value.trim();
                    
                    performSearch(currentQuery, sortKey);
                }
            });
        }
    });
</script>
{% endblock %}